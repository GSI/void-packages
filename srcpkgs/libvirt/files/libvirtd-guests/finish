#!/bin/sh

# Command guests to shut down and wait for them to finish.
# A reasonable grace period should be set via the SVWAIT environment variable.
# Example: SVWAIT=300 sv stop libvirtd-guests
# 
# Note that the "libvirtd-guests" service only handles guests marked "autostart".

request_guest_shutdown () {
	local guests="${1}"
	echo "$guests" | while read g ; do virsh shutdown "$g" ; done
}

guests=`virsh list --name --autostart | sed '/^$/d'`
request_guest_shutdown "$guests"

# Wait until guests are powered off.
while [ "$guests" != "" ] ; do
	# Apparently certain (Windows) guests want to be asked multiple
	# times to shut down.
	request_guest_shutdown "$guests"
	sleep 1
	guests=`virsh list --name --autostart | sed '/^$/d'`
done
